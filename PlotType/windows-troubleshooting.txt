# =============================================================================
# WINDOWS POWERSHELL ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° - å®Œå…¨è§£æ±ºã‚¬ã‚¤ãƒ‰
# =============================================================================

# =============================================================================
# å•é¡Œè¨ºæ–­ï¼šPowerShell ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã•ã‚Œãªã„
# =============================================================================

Write-Host "ğŸ” PowerShellå®Ÿè¡Œå•é¡Œã®è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™..." -ForegroundColor Cyan

# =============================================================================
# STEP 1: å®Ÿè¡Œãƒãƒªã‚·ãƒ¼ã®ç¢ºèªã¨ä¿®æ­£
# =============================================================================

Write-Host "`nğŸ“‹ STEP 1: PowerShellå®Ÿè¡Œãƒãƒªã‚·ãƒ¼ã®ç¢ºèª" -ForegroundColor Green

# ç¾åœ¨ã®å®Ÿè¡Œãƒãƒªã‚·ãƒ¼ç¢ºèª
$currentPolicy = Get-ExecutionPolicy
Write-Host "ç¾åœ¨ã®å®Ÿè¡Œãƒãƒªã‚·ãƒ¼: $currentPolicy" -ForegroundColor Yellow

if ($currentPolicy -eq "Restricted") {
    Write-Host "âŒ å®Ÿè¡Œãƒãƒªã‚·ãƒ¼ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™" -ForegroundColor Red
    Write-Host "è§£æ±ºæ–¹æ³•:" -ForegroundColor Cyan
    Write-Host "1. PowerShellã‚’ç®¡ç†è€…ã¨ã—ã¦èµ·å‹•" -ForegroundColor White
    Write-Host "2. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ:" -ForegroundColor White
    Write-Host "   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser" -ForegroundColor Green
    
    # è‡ªå‹•ã§å®Ÿè¡Œãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªä»˜ãï¼‰
    $changePolicy = Read-Host "`nå®Ÿè¡Œãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ (y/n)"
    if ($changePolicy -eq "y" -or $changePolicy -eq "Y") {
        try {
            Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
            Write-Host "âœ… å®Ÿè¡Œãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã—ã¾ã—ãŸ" -ForegroundColor Green
        } catch {
            Write-Host "âŒ å®Ÿè¡Œãƒãƒªã‚·ãƒ¼ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç®¡ç†è€…æ¨©é™ã§å®Ÿè¡Œã—ã¦ãã ã•ã„" -ForegroundColor Red
        }
    }
} else {
    Write-Host "âœ… å®Ÿè¡Œãƒãƒªã‚·ãƒ¼: OK ($currentPolicy)" -ForegroundColor Green
}

# =============================================================================
# STEP 2: ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
# =============================================================================

Write-Host "`nğŸ“‹ STEP 2: ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª" -ForegroundColor Green

$requiredFiles = @("check-env.ps1", "setup.ps1", "publish.ps1", "package.json")
$missingFiles = @()

foreach ($file in $requiredFiles) {
    if (Test-Path $file) {
        Write-Host "âœ… $file: å­˜åœ¨" -ForegroundColor Green
    } else {
        Write-Host "âŒ $file: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" -ForegroundColor Red
        $missingFiles += $file
    }
}

if ($missingFiles.Count -gt 0) {
    Write-Host "`nâš ï¸  ä¸è¶³ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ä½œæˆã—ã¾ã™:" -ForegroundColor Yellow
}

# =============================================================================
# STEP 3: ç°¡å˜ãªç’°å¢ƒç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆï¼‰
# =============================================================================

Write-Host "`nğŸ“‹ STEP 3: ç’°å¢ƒç¢ºèªï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè¡Œï¼‰" -ForegroundColor Green

# Node.jsç¢ºèª
try {
    $nodeVersion = & node --version 2>$null
    if ($nodeVersion) {
        Write-Host "âœ… Node.js: $nodeVersion" -ForegroundColor Green
    } else {
        throw "Node.js not found"
    }
} catch {
    Write-Host "âŒ Node.js: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" -ForegroundColor Red
    Write-Host "   ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: https://nodejs.org/" -ForegroundColor Yellow
}

# npmç¢ºèª
try {
    $npmVersion = & npm --version 2>$null
    if ($npmVersion) {
        Write-Host "âœ… npm: v$npmVersion" -ForegroundColor Green
    }
} catch {
    Write-Host "âŒ npm: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" -ForegroundColor Red
}

# Pythonç¢ºèª
try {
    $pythonVersion = & python --version 2>$null
    if ($pythonVersion) {
        Write-Host "âœ… Python: $pythonVersion" -ForegroundColor Green
    } else {
        # python3ã‚’è©¦ã™
        $pythonVersion = & python3 --version 2>$null
        if ($pythonVersion) {
            Write-Host "âœ… Python: $pythonVersion (python3 ã‚³ãƒãƒ³ãƒ‰ã§åˆ©ç”¨å¯èƒ½)" -ForegroundColor Green
        } else {
            throw "Python not found"
        }
    }
} catch {
    Write-Host "âŒ Python: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" -ForegroundColor Red
    Write-Host "   ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: https://python.org/" -ForegroundColor Yellow
    Write-Host "   é‡è¦: 'Add Python to PATH' ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹" -ForegroundColor Yellow
}

# pipç¢ºèª
try {
    $pipVersion = & pip --version 2>$null
    if ($pipVersion) {
        Write-Host "âœ… pip: åˆ©ç”¨å¯èƒ½" -ForegroundColor Green
    }
} catch {
    Write-Host "âŒ pip: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" -ForegroundColor Red
}

# Gitç¢ºèª
try {
    $gitVersion = & git --version 2>$null
    if ($gitVersion) {
        Write-Host "âœ… Git: $gitVersion" -ForegroundColor Green
    } else {
        throw "Git not found"
    }
} catch {
    Write-Host "âŒ Git: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" -ForegroundColor Red
    Write-Host "   ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: https://git-scm.com/" -ForegroundColor Yellow
}

# JupyterLabç¢ºèª
try {
    $jupyterOutput = & jupyter --version 2>$null
    if ($jupyterOutput) {
        Write-Host "âœ… JupyterLab: åˆ©ç”¨å¯èƒ½" -ForegroundColor Green
    } else {
        throw "Jupyter not found"
    }
} catch {
    Write-Host "âš ï¸  JupyterLab: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" -ForegroundColor Yellow
    Write-Host "   ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: pip install jupyterlab" -ForegroundColor White
}

# =============================================================================
# STEP 4: ä¸è¶³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
# =============================================================================

if ($missingFiles.Count -gt 0) {
    Write-Host "`nğŸ“‹ STEP 4: ä¸è¶³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ" -ForegroundColor Green
    
    $createFiles = Read-Host "ä¸è¶³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ (y/n)"
    if ($createFiles -eq "y" -or $createFiles -eq "Y") {
        
        # check-env.ps1 ä½œæˆ
        if ("check-env.ps1" -in $missingFiles) {
            Write-Host "ğŸ“ check-env.ps1 ã‚’ä½œæˆä¸­..." -ForegroundColor Cyan
            
            $checkEnvContent = @'
# LabFlowç’°å¢ƒç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆ
Write-Host "ğŸ” LabFlow Environment Check" -ForegroundColor Cyan
Write-Host "=" * 40

# Node.js
try {
    $nodeVersion = node --version
    Write-Host "âœ… Node.js: $nodeVersion" -ForegroundColor Green
} catch {
    Write-Host "âŒ Node.js: Not found" -ForegroundColor Red
}

# Python
try {
    $pythonVersion = python --version
    Write-Host "âœ… Python: $pythonVersion" -ForegroundColor Green
} catch {
    Write-Host "âŒ Python: Not found" -ForegroundColor Red
}

# Git
try {
    $gitVersion = git --version
    Write-Host "âœ… Git: $gitVersion" -ForegroundColor Green
} catch {
    Write-Host "âŒ Git: Not found" -ForegroundColor Red
}

Write-Host "`nğŸ¯ Ready to proceed!" -ForegroundColor Green
'@
            
            $checkEnvContent | Out-File -FilePath "check-env.ps1" -Encoding UTF8
            Write-Host "âœ… check-env.ps1 ä½œæˆå®Œäº†" -ForegroundColor Green
        }
        
        # setup.ps1 ä½œæˆ
        if ("setup.ps1" -in $missingFiles) {
            Write-Host "ğŸ“ setup.ps1 ã‚’ä½œæˆä¸­..." -ForegroundColor Cyan
            
            $setupContent = @'
# LabFlow Setup Script
Write-Host "ğŸ§ª LabFlow Setup Starting..." -ForegroundColor Cyan

# ç’°å¢ƒç¢ºèª
Write-Host "ğŸ“‹ Checking environment..." -ForegroundColor Green

# Node.js dependencies
if (Test-Path "package.json") {
    Write-Host "ğŸ“¦ Installing Node.js dependencies..." -ForegroundColor Green
    npm install
    if ($LASTEXITCODE -eq 0) {
        Write-Host "âœ… Node.js dependencies installed" -ForegroundColor Green
    } else {
        Write-Host "âŒ npm install failed" -ForegroundColor Red
        exit 1
    }
} else {
    Write-Host "âŒ package.json not found" -ForegroundColor Red
    exit 1
}

# Python package (if pyproject.toml exists)
if (Test-Path "pyproject.toml") {
    Write-Host "ğŸ Installing Python package..." -ForegroundColor Green
    pip install -e .
    if ($LASTEXITCODE -eq 0) {
        Write-Host "âœ… Python package installed" -ForegroundColor Green
    }
}

Write-Host "âœ… Setup complete!" -ForegroundColor Green
'@
            
            $setupContent | Out-File -FilePath "setup.ps1" -Encoding UTF8
            Write-Host "âœ… setup.ps1 ä½œæˆå®Œäº†" -ForegroundColor Green
        }
        
        # package.json ä½œæˆ
        if ("package.json" -in $missingFiles) {
            Write-Host "ğŸ“ package.json ã‚’ä½œæˆä¸­..." -ForegroundColor Cyan
            
            $packageJsonContent = @'
{
  "name": "@labflow/jupyterlab-extension",
  "version": "1.0.0",
  "description": "LabFlow - AI Development Workflow for JupyterLab",
  "main": "lib/index.js",
  "scripts": {
    "build": "echo 'Build script placeholder'",
    "clean": "echo 'Clean script placeholder'"
  },
  "devDependencies": {
    "typescript": "~5.0.2"
  },
  "license": "MIT"
}
'@
            
            $packageJsonContent | Out-File -FilePath "package.json" -Encoding UTF8
            Write-Host "âœ… package.json ä½œæˆå®Œäº†" -ForegroundColor Green
        }
    }
}

# =============================================================================
# STEP 5: ä»£æ›¿å®Ÿè¡Œæ–¹æ³•ã®ææ¡ˆ
# =============================================================================

Write-Host "`nğŸ“‹ STEP 5: ä»£æ›¿å®Ÿè¡Œæ–¹æ³•" -ForegroundColor Green

Write-Host "PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã§ããªã„å ´åˆã®ä»£æ›¿æ‰‹æ®µ:" -ForegroundColor Cyan

Write-Host "`næ–¹æ³•1: ç›´æ¥ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ" -ForegroundColor Yellow
Write-Host "   node --version" -ForegroundColor White
Write-Host "   python --version" -ForegroundColor White
Write-Host "   git --version" -ForegroundColor White
Write-Host "   jupyter --version" -ForegroundColor White

Write-Host "`næ–¹æ³•2: ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ä½¿ç”¨" -ForegroundColor Yellow
Write-Host "   check-env.bat ã‚’ä½œæˆã—ã¦å®Ÿè¡Œ" -ForegroundColor White

Write-Host "`næ–¹æ³•3: æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—" -ForegroundColor Yellow
Write-Host "   npm install" -ForegroundColor White
Write-Host "   pip install -e ." -ForegroundColor White

# =============================================================================
# STEP 6: ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆã®ä½œæˆ
# =============================================================================

Write-Host "`nğŸ“‹ STEP 6: ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆã®ä½œæˆ" -ForegroundColor Green

$createBatch = Read-Host "ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆã‚‚ä½œæˆã—ã¾ã™ã‹ï¼Ÿ (y/n)"
if ($createBatch -eq "y" -or $createBatch -eq "Y") {
    
    # check-env.bat
    $batchCheckContent = @'
@echo off
echo ğŸ” LabFlow Environment Check (Batch)
echo ========================================

echo Checking Node.js...
node --version >nul 2>&1
if %errorlevel% equ 0 (
    node --version
    echo âœ… Node.js: Found
) else (
    echo âŒ Node.js: Not found
)

echo.
echo Checking Python...
python --version >nul 2>&1
if %errorlevel% equ 0 (
    python --version
    echo âœ… Python: Found
) else (
    echo âŒ Python: Not found
)

echo.
echo Checking Git...
git --version >nul 2>&1
if %errorlevel% equ 0 (
    git --version
    echo âœ… Git: Found
) else (
    echo âŒ Git: Not found
)

echo.
echo ğŸ¯ Environment check complete!
pause
'@
    
    $batchCheckContent | Out-File -FilePath "check-env.bat" -Encoding ASCII
    Write-Host "âœ… check-env.bat ä½œæˆå®Œäº†" -ForegroundColor Green
    
    # setup.bat  
    $batchSetupContent = @'
@echo off
echo ğŸ§ª LabFlow Setup (Batch)
echo =========================

echo ğŸ“¦ Installing Node.js dependencies...
if exist package.json (
    call npm install
    if %errorlevel% equ 0 (
        echo âœ… Node.js dependencies installed
    ) else (
        echo âŒ npm install failed
        pause
        exit /b 1
    )
) else (
    echo âŒ package.json not found
    pause
    exit /b 1
)

echo.
echo ğŸ Installing Python package...
if exist pyproject.toml (
    pip install -e .
    if %errorlevel% equ 0 (
        echo âœ… Python package installed
    )
)

echo.
echo âœ… Setup complete!
pause
'@
    
    $batchSetupContent | Out-File -FilePath "setup.bat" -Encoding ASCII
    Write-Host "âœ… setup.bat ä½œæˆå®Œäº†" -ForegroundColor Green
}

# =============================================================================
# STEP 7: æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®æ¡ˆå†…
# =============================================================================

Write-Host "`nğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:" -ForegroundColor Cyan
Write-Host "1. PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è©¦ã™: .\check-env.ps1" -ForegroundColor White
Write-Host "2. ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’è©¦ã™: check-env.bat" -ForegroundColor White
Write-Host "3. æ‰‹å‹•ã§ç’°å¢ƒç¢ºèª: node --version, python --version" -ForegroundColor White
Write-Host "4. å•é¡ŒãŒè§£æ±ºã—ãŸã‚‰: .\setup.ps1 ã¾ãŸã¯ setup.bat" -ForegroundColor White

Write-Host "`nğŸ’¡ ãƒ’ãƒ³ãƒˆ:" -ForegroundColor Yellow
Write-Host "- PowerShellã¯ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œ" -ForegroundColor White
Write-Host "- å®Ÿè¡Œãƒãƒªã‚·ãƒ¼ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å¤‰æ›´ãŒå¿…è¦" -ForegroundColor White
Write-Host "- ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«(.bat)ã¯å®Ÿè¡Œãƒãƒªã‚·ãƒ¼ã®å½±éŸ¿ã‚’å—ã‘ãªã„" -ForegroundColor White

Write-Host "`nâœ… ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®Œäº†!" -ForegroundColor Green